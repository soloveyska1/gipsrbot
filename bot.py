import os
import logging
import json
import html
import re
from typing import Optional
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, ContextTypes,
    CallbackQueryHandler, MessageHandler, filters, ConversationHandler
)
from telegram.constants import ParseMode
from telegram.error import TelegramError
from telegram.helpers import escape_markdown
from dotenv import load_dotenv
import pandas as pd

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
ADMIN_CHAT_ID = int(os.getenv('ADMIN_CHAT_ID', 0))

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
BASE_DIR = os.path.join(os.getcwd(), 'clients')
DATA_DIR = os.path.join(os.getcwd(), 'data')
LOGS_DIR = os.path.join(os.getcwd(), 'logs')
for directory in [BASE_DIR, DATA_DIR, LOGS_DIR]:
    os.makedirs(directory, exist_ok=True)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)
file_handler = logging.FileHandler(os.path.join(LOGS_DIR, 'bot.log'))
file_handler.setFormatter(logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s'))
logger.addHandler(file_handler)

# –§–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö
PRICES_FILE = os.path.join(DATA_DIR, 'prices.json')
REFERRALS_FILE = os.path.join(DATA_DIR, 'referrals.json')
ORDERS_FILE = os.path.join(DATA_DIR, 'orders.json')
FEEDBACKS_FILE = os.path.join(DATA_DIR, 'feedbacks.json')
BONUSES_FILE = os.path.join(DATA_DIR, 'bonuses.json')
USER_LOGS_FILE = os.path.join(DATA_DIR, 'user_logs.json')

# –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
def load_json(file_path, default=None):
    try:
        if os.path.exists(file_path):
            with open(file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        return default or {}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {file_path}: {e}")
        return default or {}

def save_json(file_path, data):
    try:
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=4)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {file_path}: {e}")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
DEFAULT_PRICES = {
    'samostoyatelnye': {'base': 2500, 'min': 2500},
    'kursovaya_teoreticheskaya': {'base': 8000, 'min': 8000},
    'kursovaya_s_empirikov': {'base': 12000, 'min': 12000},
    'diplomnaya': {'base': 35000, 'min': 35000},
    'magisterskaya': {'base': 40000, 'min': 40000},
    'normcontrol': {'base': 5000, 'min': 5000},
}

LEGACY_PRICE_KEYS = {
    'self': 'samostoyatelnye',
    'course_theory': 'kursovaya_teoreticheskaya',
    'course_empirical': 'kursovaya_s_empirikov',
    'vkr': 'diplomnaya',
    'master': 'magisterskaya',
}


def normalize_prices(raw_prices):
    normalized = {key: value.copy() for key, value in DEFAULT_PRICES.items()}
    if not isinstance(raw_prices, dict):
        return normalized

    for raw_key, raw_value in raw_prices.items():
        target_key = LEGACY_PRICE_KEYS.get(raw_key, raw_key)
        if not isinstance(raw_value, dict):
            continue
        base = float(raw_value.get('base', 0) or 0)
        minimum = float(raw_value.get('min', 0) or 0)
        default_entry = DEFAULT_PRICES.get(target_key, {'base': 0, 'min': 0})
        default_base = default_entry.get('base', 0)
        default_min = default_entry.get('min', default_base)
        if base <= 0:
            base = default_base
        base = max(base, default_base)
        if minimum <= 0:
            minimum = max(base, default_min)
        minimum = max(minimum, base, default_min)
        normalized[target_key] = {
            'base': int(base),
            'min': int(minimum),
        }
    return normalized


PRICES = normalize_prices(load_json(PRICES_FILE, {}))
REFERALS = load_json(REFERRALS_FILE)
ORDERS = load_json(ORDERS_FILE)
FEEDBACKS = load_json(FEEDBACKS_FILE)
BONUSES = load_json(BONUSES_FILE)
USER_LOGS = load_json(USER_LOGS_FILE)

ORDER_TYPES = {
    'samostoyatelnye': {
        'name': '–°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ, —ç—Å—Å–µ',
        'icon': 'üìù',
        'description': (
            '–ë—ã—Å—Ç—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚Äî —ç—Å—Å–µ, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ, —Ä–µ—Ñ–µ—Ä–∞—Ç—ã. –£–∂–µ 5000+ —Ä–∞–±–æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∏–¥–µ–∞–ª—å–Ω–æ üî•\n\n'
            '–ü–æ–¥—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—É—é –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞ –∏ –∑–∞–¥–µ—Ä–∂–µ–∫.'
        ),
        'details': (
            '‚Ä¢ –û–±—ä—ë–º: –æ—Ç 1 —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö —Å–≤—ã—à–µ 20 —Å—Ç—Ä–∞–Ω–∏—Ü.\n'
            '‚Ä¢ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è, —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–ª–æ–≥–∏—è –∏ —Å–º–µ–∂–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã.\n'
            '‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ —Å—Ä–æ–∫–∞–º, —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –æ–±—ä—ë–º—É ‚Äî –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≥–æ–¥–Ω–æ –∏ –Ω–∞–¥—ë–∂–Ω–æ.'
        ),
        'examples': ['–≠—Å—Å–µ –ø–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ –ª–∏—á–Ω–æ—Å—Ç–∏', '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –ø–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–ª–æ–≥–∏–∏', '–†–µ—Ñ–µ—Ä–∞—Ç –ø–æ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ']
    },
    'kursovaya_teoreticheskaya': {
        'name': '–ö—É—Ä—Å–æ–≤–∞—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è',
        'icon': 'üìò',
        'description': '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã. –ü–æ–ª—É—á–∏—Ç–µ –æ—Ç–ª–∏—á–Ω—É—é –æ—Ü–µ–Ω–∫—É –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞! üìà',
        'details': '–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞, –∞–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –ì–û–°–¢.',
        'examples': ['–¢–µ–æ—Ä–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞', '–û–±–∑–æ—Ä –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏ —Ä–∞–∑–≤–∏—Ç–∏—è']
    },
    'kursovaya_s_empirikov': {
        'name': '–ö—É—Ä—Å–æ–≤–∞—è —Å —ç–º–ø–∏—Ä–∏–∫–æ–π',
        'icon': 'üìä',
        'description': (
            '–¢–µ–æ—Ä–∏—è + –¥–∞–Ω–Ω—ã–µ –∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑.\n'
            '–ö–ª–∏–µ–Ω—Ç—ã –≥–æ–≤–æ—Ä—è—Ç: "–õ—É—á—à–∞—è –ø–æ–º–æ—â—å!" ‚≠êÔ∏è'
        ),
        'details': (
            '‚Ä¢ –†–∞–±–æ—Ç–∞–µ–º —Å —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –≤–º–µ—Å—Ç–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º —Å–±–æ—Ä –ø–æ–¥ –≤–∞—à—É —Ç–µ–º—É.\n'
            '‚Ä¢ –ü—Ä–æ–≤–æ–¥–∏–º –æ–ø—Ä–æ—Å—ã, —Ä–∞—Å—á—ë—Ç—ã –∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.\n'
            '‚Ä¢ –û—Ñ–æ—Ä–º–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—ã, –≥—Ä–∞—Ñ–∏–∫–∏, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –≤—É–∑–∞.\n\n'
            '–ü—Ä–∏–º–µ—Ä—ã: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞, –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π\n\n'
            '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: 12000 ‚ÇΩ –ø—Ä–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–æ–∫–∞—Ö.\n\n'
            '–ì–æ—Ç–æ–≤—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?'
        ),
        'examples': ['–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ä—ã–Ω–∫–∞', '–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π']
    },
    'diplomnaya': {
        'name': '–î–∏–ø–ª–æ–º–Ω–∞—è —Ä–∞–±–æ—Ç–∞',
        'icon': 'üéì',
        'description': '–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–ª—è —É—Å–ø–µ—à–Ω–æ–π –∑–∞—â–∏—Ç—ã. –°–∫–∏–¥–∫–∞ 10% –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–∏–ø–ª–æ–º! üíº',
        'details': '–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑, —ç–º–ø–∏—Ä–∏–∫–∞ –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –¥–æ –∑–∞—â–∏—Ç—ã.',
        'examples': ['–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤', '–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏']
    },
    'magisterskaya': {
        'name': '–ú–∞–≥–∏—Å—Ç–µ—Ä—Å–∫–∞—è –¥–∏—Å—Å–µ—Ä—Ç–∞—Ü–∏—è',
        'icon': 'üîç',
        'description': '–ò–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ. –í—ã—Å–æ–∫–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –≥–ª—É–±–∏–Ω–∞ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏. üåü',
        'details': '–ù–∞—É—á–Ω–∞—è –Ω–æ–≤–∏–∑–Ω–∞, –ø—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è–º.',
        'examples': ['–†–∞–∑–≤–∏—Ç–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π', '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–º–µ–π –≤ –∫—Ä–∏–∑–∏—Å–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö']
    },
    'normcontrol': {
        'name': '–ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å',
        'icon': 'üìê',
        'description': '–ü—Ä–æ–≤–µ—Ä–∏–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ –ì–û–°–¢ –∏ –º–µ—Ç–æ–¥–∏—á–∫–∞–º –±–µ–∑ —Å—Ç—Ä–µ—Å—Å–∞. –ë—ã—Å—Ç—Ä—ã–π —Ä–∞–∑–±–æ—Ä –∑–∞–º–µ—á–∞–Ω–∏–π.',
        'details': '–ü—Ä–∏–≤–µ–¥–µ–º —Ç–µ–∫—Å—Ç –≤ –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å—Å—ã–ª–∫–∏, —Å–ø–∏—Å–∫–∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å ‚Äî 5000 ‚ÇΩ, –¥–∞–ª–µ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ–±—ä–µ–º–∞ –∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏.',
        'examples': ['–ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å –¥–∏–ø–ª–æ–º–∞', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—É—Ä—Å–æ–≤–æ–π –ø–µ—Ä–µ–¥ —Å–¥–∞—á–µ–π']
    }
}

UPSELL_LABELS = {
    'prez': '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',
    'speech': '–†–µ—á—å'
}

UPSELL_PRICES = {
    'prez': 2000,
    'speech': 1000,
}

FEEDBACK_BONUS_AMOUNT = 200

DEADLINE_PRESETS = [
    {
        'key': '24h',
        'label': '‚è± 24 —á–∞—Å–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ',
        'days': 1,
        'multiplier': 1.8,
        'badge': '–≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏ –±–æ–Ω—É—Å –∑–∞ —Å–º–µ–ª–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞',
    },
    {
        'key': '3d',
        'label': 'üöÄ 3 –¥–Ω—è',
        'days': 3,
        'multiplier': 1.45,
        'badge': '–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Å—Ä–æ–∫ —Å –±–æ–Ω—É—Å–æ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑',
    },
    {
        'key': '5d',
        'label': '‚ö°Ô∏è 5 –¥–Ω–µ–π',
        'days': 5,
        'multiplier': 1.3,
        'badge': '–°—Ä–æ—á–Ω–æ, –Ω–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ: –ø—Ä–æ–≥—Ä–µ—Å—Å-–æ—Ç—á—ë—Ç—ã –∏ –±–æ–Ω—É—Å –∑–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ',
    },
    {
        'key': '7d',
        'label': 'üìÖ –ù–µ–¥–µ–ª—è',
        'days': 7,
        'multiplier': 1.15,
        'badge': '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–º –±–æ–Ω—É—Å–æ–º',
    },
    {
        'key': '14d',
        'label': '‚úÖ 2 –Ω–µ–¥–µ–ª–∏',
        'days': 14,
        'multiplier': 1.0,
        'badge': '–ë–∞–∑–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ–Ω—É—Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞',
    },
    {
        'key': '21d',
        'label': 'üåø 3 –Ω–µ–¥–µ–ª–∏',
        'days': 21,
        'multiplier': 0.95,
        'badge': '–°–ø–æ–∫–æ–π–Ω—ã–π —Ç–µ–º–ø: –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∏ –±–æ–Ω—É—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏',
    },
    {
        'key': '30d',
        'label': 'üßò –ú–µ—Å—è—Ü',
        'days': 30,
        'multiplier': 0.9,
        'badge': '–ë–µ–∑ —Å–ø–µ—à–∫–∏: —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è –∏ –±–æ–Ω—É—Å –∑–∞ –¥–æ–≤–µ—Ä–∏–µ',
    },
    {
        'key': '45d',
        'label': 'üõ° –ë–æ–ª—å—à–µ –º–µ—Å—è—Ü–∞',
        'days': 45,
        'multiplier': 0.85,
        'badge': '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã–≥–æ–¥–∞: –ª—É—á—à–∏–µ —É—Å–ª–æ–≤–∏—è –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–Ω—É—Å',
    },
]

DEADLINE_LOOKUP = {item['key']: item for item in DEADLINE_PRESETS}
DEFAULT_DEADLINE_KEY = '14d'


def get_deadline_preset(key):
    return DEADLINE_LOOKUP.get(key) or DEADLINE_LOOKUP[DEFAULT_DEADLINE_KEY]


def round_price(amount: float) -> int:
    return int(max(0, (float(amount) + 25) // 50 * 50))

FAQ_ITEMS = [
    {'question': '–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑?', 'answer': '–í—ã–±–µ—Ä–∏—Ç–µ "–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑" –∏ —Å–ª–µ–¥—É–π—Ç–µ —à–∞–≥–∞–º. –ú–æ–∂–Ω–æ –∑–∞–∫–∞–∑–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç —Å—Ä–∞–∑—É!'},
    {'question': '–ö–∞–∫ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å?', 'answer': '–ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞, —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–ª—è —Ç–æ—á–Ω–æ–π —Ü–µ–Ω—ã!'},
    {'question': '–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞?', 'answer': '–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π ‚Äî –ø–æ–ª—É—á–∏—Ç–µ 5% –æ—Ç –∑–∞–∫–∞–∑–æ–≤ –¥—Ä—É–∑–µ–π –∫–∞–∫ –±–æ–Ω—É—Å.'},
    {'question': '–ì–∞—Ä–∞–Ω—Ç–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞?', 'answer': '–ê–Ω—Ç–∏–ø–ª–∞–≥–∏–∞—Ç, –ø—Ä–∞–≤–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ 14 –¥–Ω–µ–π, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–æ –∑–∞—â–∏—Ç—ã.'},
    {'question': '–°–∫–∏–¥–∫–∏?', 'answer': '5-15% –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö, 10% –Ω–∞ –ø–µ—Ä–≤—ã–π, —Ä–µ—Ñ–µ—Ä–∞–ª—ã.'},
    {'question': '–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?', 'answer': '–í –ø—Ä–æ—Ñ–∏–ª–µ —Å—Ç–∞—Ç—É—Å—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞.'}
]

current_pricing_mode = 'light'

# –°–æ—Å—Ç–æ—è–Ω–∏—è
(
    SELECT_MAIN_MENU,
    SELECT_ORDER_TYPE,
    VIEW_ORDER_DETAILS,
    INPUT_TOPIC,
    SELECT_DEADLINE,
    INPUT_REQUIREMENTS,
    INPUT_CONTACT,
    UPLOAD_FILES,
    ADD_UPSSELL,
    ADD_ANOTHER_ORDER,
    CONFIRM_CART,
    ADMIN_MENU,
    PROFILE_MENU,
    SHOW_PRICE_LIST,
    PRICE_CALCULATOR,
    SELECT_CALC_DEADLINE,
    SELECT_CALC_COMPLEXITY,
    SHOW_FAQ,
    FAQ_DETAILS,
    PROFILE_ORDERS,
    PROFILE_ORDER_DETAIL,
    PROFILE_FEEDBACKS,
    PROFILE_FEEDBACK_INPUT,
    PROFILE_REFERRALS,
    PROFILE_BONUSES,
) = range(25)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def log_user_action(user_id, username, action):
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    USER_LOGS.setdefault(str(user_id), []).append({'timestamp': timestamp, 'action': action, 'username': username})
    save_json(USER_LOGS_FILE, USER_LOGS)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({username}): {action}")

async def answer_callback_query(query, context):
    if not query:
        return
    last_answered_id = context.user_data.get('_last_answered_query')
    if last_answered_id == query.id:
        return
    await query.answer()
    context.user_data['_last_answered_query'] = query.id


def ensure_bonus_account(user_id: str):
    user_key = str(user_id)
    entry = BONUSES.setdefault(user_key, {})
    changed = False
    credited = entry.get('credited', 0)
    redeemed = entry.get('redeemed', 0)
    history = entry.get('history', [])
    balance = entry.get('balance')
    try:
        credited = int(credited)
    except (TypeError, ValueError):
        credited = 0
        changed = True
    try:
        redeemed = int(redeemed)
    except (TypeError, ValueError):
        redeemed = 0
        changed = True
    if not isinstance(history, list):
        history = []
        changed = True
    calculated_balance = credited - redeemed
    try:
        balance = int(balance)
    except (TypeError, ValueError):
        balance = calculated_balance
        changed = True
    if balance != calculated_balance:
        balance = calculated_balance
        changed = True
    entry.update({
        'credited': credited,
        'redeemed': redeemed,
        'balance': balance,
        'history': history,
    })
    if changed:
        save_json(BONUSES_FILE, BONUSES)
    return entry


def get_bonus_summary(user_id: str):
    entry = ensure_bonus_account(user_id)
    return (
        entry.get('credited', 0),
        entry.get('redeemed', 0),
        entry.get('balance', 0),
        entry.get('history', []),
    )


def add_bonus_operation(user_id: str, amount: int, operation_type: str, reason: str):
    amount = int(amount)
    entry = ensure_bonus_account(user_id)
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    if operation_type == 'credit':
        entry['credited'] += amount
        entry['balance'] += amount
    elif operation_type == 'debit':
        entry['redeemed'] += amount
        entry['balance'] = max(0, entry['balance'] - amount)
    entry.setdefault('history', []).append({
        'type': operation_type,
        'amount': amount,
        'reason': reason,
        'timestamp': timestamp,
    })
    save_json(BONUSES_FILE, BONUSES)


def get_feedback_entries(user_id: str):
    items = FEEDBACKS.get(str(user_id), [])
    normalized = []
    for entry in items:
        if isinstance(entry, dict):
            text = entry.get('text', '')
            created_at = entry.get('created_at')
        else:
            text = str(entry)
            created_at = None
        normalized.append({'text': text, 'created_at': created_at})
    return normalized


def save_feedback_entries(user_id: str, entries):
    FEEDBACKS[str(user_id)] = entries
    save_json(FEEDBACKS_FILE, FEEDBACKS)


def truncate_for_button(text: str, limit: int = 32) -> str:
    clean = text.replace('\n', ' ').strip()
    if len(clean) <= limit:
        return clean
    return clean[: limit - 1] + '‚Ä¶'


def is_order_paused(order: dict) -> bool:
    status = str(order.get('status', '')).lower()
    return bool(order.get('client_paused')) or status.startswith('–Ω–∞ –ø–∞—É–∑–µ')


def build_order_status(order: dict) -> str:
    status = order.get('status') or '–±–µ–∑ —Å—Ç–∞—Ç—É—Å–∞'
    if is_order_paused(order):
        return f"{status} ¬∑ –Ω–∞ –ø–∞—É–∑–µ"
    return status


def build_order_detail_text(order: dict) -> str:
    order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø')
    topic = order.get('topic', '–ë–µ–∑ —Ç–µ–º—ã')
    deadline_display = order.get('deadline_label') or f"{order.get('deadline_days', '‚Äî')} –¥–Ω–µ–π"
    upsell_titles = [UPSELL_LABELS.get(u, u) for u in order.get('upsells', [])]
    upsell_text = ', '.join(upsell_titles) if upsell_titles else '–Ω–µ—Ç'
    contact_display = html.escape(order.get('contact', '–ù–µ —É–∫–∞–∑–∞–Ω'))
    contact_link = order.get('contact_link')
    if contact_link:
        contact_html = f"<a href=\"{html.escape(contact_link, quote=True)}\">{contact_display}</a>"
    else:
        contact_html = contact_display
    requirements = html.escape(order.get('requirements', '–ù–µ—Ç'))
    files_count = len(order.get('files', [])) if order.get('files') else 0
    lines = [
        f"<b>{html.escape(order_name)}</b>",
        f"–¢–µ–º–∞: {html.escape(topic)}",
        f"–°—Ç–∞—Ç—É—Å: {html.escape(build_order_status(order))}",
        f"–°—Ä–æ–∫: {html.escape(deadline_display)}",
        f"–ö–æ–Ω—Ç–∞–∫—Ç: {contact_html}",
        f"–î–æ–ø—ã: {html.escape(upsell_text)}",
        f"–°—Ç–æ–∏–º–æ—Å—Ç—å: {order.get('price', 0)} ‚ÇΩ",
        f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {requirements}",
    ]
    if files_count:
        lines.append(f"–§–∞–π–ª—ã: {files_count} —à—Ç.")
    return "\n".join(lines)


def find_user_order(user_id: str, order_id: str):
    user_orders = ORDERS.get(str(user_id), [])
    for order in user_orders:
        if str(order.get('order_id')) == str(order_id):
            return order, user_orders
    return None, user_orders


async def edit_or_send(update: Update, context: ContextTypes.DEFAULT_TYPE, text: str, keyboard=None, parse_mode=ParseMode.HTML):
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None
    if update.callback_query:
        query = update.callback_query
        await query.edit_message_text(
            text,
            reply_markup=reply_markup,
            parse_mode=parse_mode,
            disable_web_page_preview=True,
        )
    elif update.message:
        await update.message.reply_text(
            text,
            reply_markup=reply_markup,
            parse_mode=parse_mode,
            disable_web_page_preview=True,
        )
    else:
        chat_id = update.effective_chat.id
        await context.bot.send_message(
            chat_id,
            text,
            reply_markup=reply_markup,
            parse_mode=parse_mode,
            disable_web_page_preview=True,
        )

def build_contact_link(contact_text):
    if not contact_text:
        return None
    contact = contact_text.strip()
    if not contact:
        return None
    lowered = contact.lower()
    if lowered.startswith(('http://', 'https://', 'tg://', 'mailto:')):
        return contact
    if lowered.startswith(('t.me/', 'telegram.me/')):
        return f"https://{contact}" if lowered.startswith('t.me/') else f"https://{contact.split('://', 1)[-1]}"
    if lowered.startswith('vk.com/'):
        return f"https://{contact}"
    if contact.startswith('@') and re.fullmatch(r'@[A-Za-z0-9_]{4,}', contact):
        return f"https://t.me/{contact[1:]}"
    if re.fullmatch(r'[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}', contact):
        return f"mailto:{contact}"
    if lowered.startswith(('vk.com', 't.me')):
        return f"https://{contact}"
    return None


def build_deadline_keyboard(callback_prefix: str, include_back: bool = False, back_callback: Optional[str] = None):
    rows = []
    for i in range(0, len(DEADLINE_PRESETS), 2):
        chunk = DEADLINE_PRESETS[i:i + 2]
        row = [
            InlineKeyboardButton(item['label'], callback_data=f"{callback_prefix}{item['key']}")
            for item in chunk
        ]
        rows.append(row)
    if include_back and back_callback:
        rows.append([InlineKeyboardButton('‚¨ÖÔ∏è –ù–∞–∑–∞–¥', callback_data=back_callback)])
    return InlineKeyboardMarkup(rows)


REQUIREMENTS_PROMPT_TEXT = (
    "üìö *–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø—Ä–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è.*\n"
    "‚Ä¢ –ß—Ç–æ —É–∫–∞–∑–∞–Ω–æ –≤ –º–µ—Ç–æ–¥–∏—á–∫–µ –∏–ª–∏ –∑–∞–¥–∞–Ω–∏–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è.\n"
    "‚Ä¢ –û–±—ä—ë–º, —Ñ–æ—Ä–º–∞—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è, —Å–ø–∏—Å–æ–∫ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã, –ø—Ä–∏–º–µ—Ä—ã –∂–µ–ª–∞–µ–º–æ–≥–æ —É—Ä–æ–≤–Ω—è.\n"
    "–ú–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º —Å–µ–π—á–∞—Å –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã —á—É—Ç—å –ø–æ–∑–∂–µ –Ω–∞ —à–∞–≥–µ —Å —Ñ–∞–π–ª–∞–º–∏.\n\n"
    "–ï—Å–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–∏–π –Ω–µ—Ç, –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /skip."
)

REQUIREMENTS_EXAMPLE_TEXT = (
    "–ü—Ä–∏–º–µ—Ä: ¬´–ú–µ—Ç–æ–¥–∏—á–∫–∞ ‚Ññ3, —Ç–µ–º–∞ 2, –æ–±—ä—ë–º 8 —Å—Ç—Ä–∞–Ω–∏—Ü, Times New Roman 14, –∏–Ω—Ç–µ—Ä–≤–∞–ª 1,5; –Ω—É–∂–Ω–æ 3 –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è.¬ª"
)


def build_requirements_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton('üí° –ü–æ–¥—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å', callback_data='requirements_hint')],
        [InlineKeyboardButton('‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', callback_data='requirements_skip')],
    ])


def get_user_link(user):
    if user.username:
        return f"https://t.me/{user.username}"
    return f"tg://user?id={user.id}"

# –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã
def calculate_price(order_type_key: str, deadline_key: str, complexity_factor: float = 1.0) -> int:
    if order_type_key not in PRICES:
        logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø: {order_type_key}")
        return 0
    pricing = PRICES[order_type_key]
    base = pricing.get('base', pricing.get('min', 0))
    min_price = pricing.get('min', base)
    preset = get_deadline_preset(deadline_key)
    deadline_multiplier = preset.get('multiplier', 1.0)
    mode_multiplier = 1.1 if current_pricing_mode == 'hard' else 1.0
    raw_price = base * deadline_multiplier * complexity_factor * mode_multiplier
    price = max(raw_price, min_price)
    return round_price(price)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"–û—à–∏–±–∫–∞: {context.error}")
    if ADMIN_CHAT_ID:
        await context.bot.send_message(ADMIN_CHAT_ID, f"–û—à–∏–±–∫–∞: {context.error}")

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    log_user_action(user.id, user.username, "/start")
    message_text = update.message.text if update.message and update.message.text else ""
    args = message_text.split()
    bot_username = (await context.bot.get_me()).username
    ref_link = f"https://t.me/{bot_username}?start={user.id}"
    context.user_data['ref_link'] = ref_link
    if len(args) > 1 and args[1].isdigit():
        referrer_id = int(args[1])
        if referrer_id != user.id:
            REFERALS.setdefault(str(referrer_id), []).append(user.id)
            save_json(REFERRALS_FILE, REFERALS)
            await context.bot.send_message(referrer_id, f"üéâ –ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª: {user.first_name}")
    display_name = user.first_name or user.full_name or "–¥—Ä—É–≥"
    safe_name = escape_markdown(display_name, version=1)
    safe_ref_link = escape_markdown(ref_link, version=1)
    welcome = (
        f"üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {safe_name}! –†–∞–±–æ—Ç–∞–µ–º —Å–æ –≤—Å–µ–º–∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º–∏, –∫—Ä–æ–º–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö (—á–µ—Ä—Ç–µ–∂–∏)."
        f" –£–∂–µ 5000+ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ 10% —Å–∫–∏–¥–∫–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ üî•\n–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π –¥–ª—è –±–æ–Ω—É—Å–æ–≤: {safe_ref_link}"
    )
    return await main_menu(update, context, welcome)

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
async def main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE, message=None):
    user = update.effective_user
    log_user_action(user.id, user.username, "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    text = message or "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    keyboard = [
        [InlineKeyboardButton("üìù –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑", callback_data='make_order')],
        [InlineKeyboardButton("üí≤ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç", callback_data='price_list'), InlineKeyboardButton("üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", callback_data='price_calculator')],
        [InlineKeyboardButton("üë§ –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile'), InlineKeyboardButton("‚ùì FAQ", callback_data='faq')],
        [InlineKeyboardButton("üìû –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", url='https://t.me/Thisissaymoon')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    if update.callback_query:
        query = update.callback_query
        await answer_callback_query(query, context)
        try:
            await query.edit_message_text(text, reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)
        except TelegramError as e:
            if "message is not modified" in str(e).lower():
                pass
            else:
                logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)
    return SELECT_MAIN_MENU

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
async def main_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    user = update.effective_user
    log_user_action(user.id, user.username, f"–í—ã–±–æ—Ä –≤ –º–µ–Ω—é: {data}")
    if data == 'make_order':
        return await select_order_type(update, context)
    elif data == 'price_list':
        return await show_price_list(update, context)
    elif data == 'price_calculator':
        return await price_calculator(update, context)
    elif data == 'profile':
        return await show_profile(update, context)
    elif data == 'faq':
        return await show_faq(update, context)
    await query.edit_message_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.")
    return await main_menu(update, context)
    return SELECT_MAIN_MENU

# –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–∞
async def select_order_type(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data if query else None
    user = update.effective_user
    log_user_action(user.id, user.username, "–í—ã–±–æ—Ä —Ç–∏–ø–∞ –∑–∞–∫–∞–∑–∞")
    if data and data.startswith('type_'):
        return await view_order_details(update, context)
    if data == 'back_to_main':
        return await main_menu(update, context)
    text = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–±–æ—Ç—ã (–¥–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤ –∫–æ—Ä–∑–∏–Ω—É –¥–ª—è —Å–∫–∏–¥–∫–∏!):"
    keyboard = [[InlineKeyboardButton(f"{val['icon']} {val['name']}", callback_data=f'type_{key}')] for key, val in ORDER_TYPES.items()]
    navigation_row = [InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')]
    current_type = context.user_data.get('current_order_type')
    if current_type in ORDER_TYPES:
        navigation_row.append(InlineKeyboardButton("üîô –ö –æ–ø–∏—Å–∞–Ω–∏—é", callback_data=f'type_{current_type}'))
    keyboard.append(navigation_row)
    reply_markup = InlineKeyboardMarkup(keyboard)
    try:
        await query.edit_message_text(text, reply_markup=reply_markup)
    except TelegramError as e:
        if "message is not modified" in str(e).lower():
            pass
        else:
            raise
    return SELECT_ORDER_TYPE

# –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ —Ç–∏–ø–µ –∑–∞–∫–∞–∑–∞
async def view_order_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('order_'):
        key = data[6:]
        context.user_data['current_order_type'] = key
        prompt_lines = [
            "‚úçÔ∏è *–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –∑–∞–¥–∞–Ω–∏—è.*",
            "–û–ø–∏—à–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É, —Ñ–æ—Ä–º–∞—Ç –∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∞–∫—Ü–µ–Ω—Ç—ã, —á—Ç–æ–±—ã –º—ã —Å—Ä–∞–∑—É –ø–µ—Ä–µ–¥–∞–ª–∏ –∑–∞–¥–∞—á—É –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–º—É —ç–∫—Å–ø–µ—Ä—Ç—É.",
            "–ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π —Ç–µ–º—ã –µ—â—ë –Ω–µ—Ç ‚Äî —Ç–∞–∫ –∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∏ –º—ã –ø–æ–º–æ–∂–µ–º —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.",
        ]
        if key == 'samostoyatelnye':
            prompt_lines.append(
                "–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–≠—Å—Å–µ –ø–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–ª–æ–≥–∏–∏ –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö –º–µ–¥–∏–∞—Ü–∏–∏¬ª –∏–ª–∏ ¬´–†–µ—Ñ–µ—Ä–∞—Ç –ø–æ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ –æ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–µ –≤—ã–≥–æ—Ä–∞–Ω–∏—è¬ª."
            )
        await query.edit_message_text(
            "\n\n".join(prompt_lines),
            parse_mode=ParseMode.MARKDOWN,
        )
        return INPUT_TOPIC
    elif data == 'select_order_type':
        return await select_order_type(update, context)
    elif data.startswith('type_'):
        key = data[5:]
        if key not in ORDER_TYPES:
            await query.edit_message_text("–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø.")
            return SELECT_ORDER_TYPE
        val = ORDER_TYPES[key]
        prices = PRICES.get(key, {})
        min_price = prices.get('min') or prices.get('base')
        price_line = f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {min_price} ‚ÇΩ –ø—Ä–∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–æ–∫–∞—Ö." if min_price else ""
        text = (
            f"{val['icon']} *{val['name']}*\n\n{val['description']}\n{val['details']}\n"
            f"–ü—Ä–∏–º–µ—Ä—ã: {', '.join(val['examples'])}"
        )
        if price_line:
            text += f"\n\n{price_line}"
        text += "\n\n–ì–æ—Ç–æ–≤—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?"
        keyboard = [
            [InlineKeyboardButton("‚úÖ –ó–∞–∫–∞–∑–∞—Ç—å", callback_data=f'order_{key}')],
            [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='select_order_type')]
        ]
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN, reply_markup=InlineKeyboardMarkup(keyboard))
        return VIEW_ORDER_DETAILS

# –í–≤–æ–¥ —Ç–µ–º—ã
async def input_topic(update: Update, context: ContextTypes.DEFAULT_TYPE):
    topic_text = (update.message.text or '').strip()
    context.user_data['topic'] = topic_text
    user = update.effective_user
    log_user_action(user.id, user.username, f"–¢–µ–º–∞: {update.message.text}")
    descriptions = [
        "‚è∞ *–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ —Å–¥–∞—á–∏ ‚Äî —á–µ–º —Å–ø–æ–∫–æ–π–Ω–µ–µ, —Ç–µ–º –≤—ã–≥–æ–¥–Ω–µ–µ.*",
        "_–ú—ã –∑–∞–∫—Ä–µ–ø–ª—è–µ–º –±–æ–Ω—É—Å—ã –∑–∞ —Ä–∞–Ω–Ω–∏–π –∑–∞–∫–∞–∑ ‚Äî –≤—ã–±–∏—Ä–∞–π—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:_",
        "",
    ]
    for preset in DEADLINE_PRESETS:
        descriptions.append(f"{preset['label']} ‚Äî {preset['badge']}")
    text = "\n".join(descriptions)
    back_target = context.user_data.get('current_order_type')
    reply_markup = build_deadline_keyboard(
        'deadline_',
        include_back=True,
        back_callback=f'type_{back_target}' if back_target else 'select_order_type'
    )
    await update.message.reply_text(
        text,
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN,
        disable_web_page_preview=True,
    )
    return SELECT_DEADLINE

# –í—ã–±–æ—Ä —Å—Ä–æ–∫–∞
async def select_deadline(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('deadline_'):
        key = data[9:]
        preset = get_deadline_preset(key)
        context.user_data['deadline_key'] = key
        context.user_data['deadline_days'] = preset['days']
        context.user_data['deadline_label'] = preset['label']
        await query.edit_message_text(
            REQUIREMENTS_PROMPT_TEXT,
            reply_markup=build_requirements_keyboard(),
            parse_mode=ParseMode.MARKDOWN,
            disable_web_page_preview=True,
        )
        return INPUT_REQUIREMENTS
    elif data.startswith('type_'):
        return await view_order_details(update, context)
    return SELECT_DEADLINE

# –í–≤–æ–¥ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
async def input_requirements(update: Update, context: ContextTypes.DEFAULT_TYPE):
    requirements_text = (update.message.text or '').strip()
    context.user_data['requirements'] = requirements_text or '–ù–µ—Ç'
    return await ask_contact(update, context)

async def skip_requirements(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data['requirements'] = '–ù–µ—Ç'
    return await ask_contact(update, context)


async def requirements_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data == 'requirements_hint':
        await query.message.reply_text(REQUIREMENTS_EXAMPLE_TEXT)
        return INPUT_REQUIREMENTS
    if data == 'requirements_skip':
        context.user_data['requirements'] = '–ù–µ—Ç'
        await query.edit_message_text('‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ–∑–∂–µ.')
        return await ask_contact(update, context)
    return INPUT_REQUIREMENTS

async def ask_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üì¨ *–û—Å—Ç–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç, –∫—É–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É –Ω–∞–ø–∏—Å–∞—Ç—å.*\n"
        "–ü—Ä–∏—à–ª–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ Telegram, VK –∏–ª–∏ —Ä–∞–±–æ—á—É—é –ø–æ—á—Ç—É ‚Äî —Ç–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä –±—ã—Å—Ç—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.\n"
        "–ü—Ä–∏–º–µ—Ä: https://t.me/username, @username, https://vk.com/id123 –∏–ª–∏ name@example.com.\n"
        "_–ë–µ–∑ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –º—ã –Ω–µ —Å–º–æ–∂–µ–º –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑._"
    )
    if update.message:
        target = update.message
    else:
        target = update.callback_query.message
    await target.reply_text(
        text,
        parse_mode=ParseMode.MARKDOWN,
        disable_web_page_preview=True,
    )
    return INPUT_CONTACT

async def input_contact(update: Update, context: ContextTypes.DEFAULT_TYPE):
    contact_text = update.message.text.strip()
    link = build_contact_link(contact_text)
    if not link:
        await update.message.reply_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Ä–∞–±–æ—á—É—é —Å—Å—ã–ª–∫—É –∏–ª–∏ e-mail, —á—Ç–æ–±—ã –º—ã —Å–º–æ–≥–ª–∏ –Ω–∞–ø–∏—Å–∞—Ç—å –≤–∞–º.\n"
            "–ü—Ä–∏–º–µ—Ä—ã: https://t.me/username, @username, https://vk.com/id123, name@example.com",
            disable_web_page_preview=True,
        )
        return INPUT_CONTACT
    context.user_data['contact'] = contact_text
    context.user_data['contact_link'] = link
    context.user_data['pending_files'] = []
    return await prompt_file_upload(update, context)

async def prompt_file_upload(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–¥–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å).\n\n"
        "‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ –æ–¥–Ω–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –∞—É–¥–∏–æ.\n"
        "‚Ä¢ –ö–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ, –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /done.\n"
        "‚Ä¢ –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç, –Ω–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å¬ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /skip."
    )
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –ì–æ—Ç–æ–≤–æ", callback_data='files_done')],
        [InlineKeyboardButton("‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data='files_skip')]
    ])
    await update.message.reply_text(text, reply_markup=keyboard)
    return UPLOAD_FILES

async def handle_file_upload(update: Update, context: ContextTypes.DEFAULT_TYPE):
    files_list = context.user_data.setdefault('pending_files', [])
    message = update.message
    acknowledgement = None
    if message.document:
        document = message.document
        files_list.append({
            'type': 'document',
            'file_id': document.file_id,
            'file_name': document.file_name,
        })
        acknowledgement = f"üìÑ –§–∞–π–ª {document.file_name or '–∑–∞–≥—Ä—É–∂–µ–Ω'} —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
    elif message.photo:
        photo = message.photo[-1]
        files_list.append({
            'type': 'photo',
            'file_id': photo.file_id,
        })
        acknowledgement = "üñº –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ."
    elif message.audio:
        audio = message.audio
        files_list.append({
            'type': 'audio',
            'file_id': audio.file_id,
            'file_name': audio.file_name or audio.title,
        })
        acknowledgement = "üéß –ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ."
    elif message.voice:
        voice = message.voice
        files_list.append({
            'type': 'voice',
            'file_id': voice.file_id,
        })
        acknowledgement = "üéô –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ."
    elif message.video:
        video = message.video
        files_list.append({
            'type': 'video',
            'file_id': video.file_id,
            'file_name': video.file_name,
        })
        acknowledgement = "üé¨ –í–∏–¥–µ–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ."
    elif message.video_note:
        video_note = message.video_note
        files_list.append({
            'type': 'video_note',
            'file_id': video_note.file_id,
        })
        acknowledgement = "üìπ –í–∏–¥–µ–æ-–∑–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞."
    elif message.animation:
        animation = message.animation
        files_list.append({
            'type': 'animation',
            'file_id': animation.file_id,
            'file_name': animation.file_name,
        })
        acknowledgement = "üåÄ GIF —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
    elif message.sticker:
        sticker = message.sticker
        files_list.append({
            'type': 'sticker',
            'file_id': sticker.file_id,
            'file_emoji': sticker.emoji,
        })
        acknowledgement = "üîñ –°—Ç–∏–∫–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
    if acknowledgement:
        await message.reply_text(f"{acknowledgement} –ú–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –µ—â–µ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å ¬´–ì–æ—Ç–æ–≤–æ¬ª.")
    else:
        await message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª.")
    return UPLOAD_FILES

async def skip_file_upload(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.setdefault('pending_files', [])
    return await add_upsell(update, context)


async def file_upload_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data == 'files_skip':
        context.user_data['pending_files'] = []
    elif not context.user_data.get('pending_files'):
        context.user_data['pending_files'] = []
    return await add_upsell(update, context)

async def remind_file_upload(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ì–æ—Ç–æ–≤–æ¬ª, –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç–µ (–º–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /done).")
    return UPLOAD_FILES

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø—É—Å–ª—É–≥
async def add_upsell(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        '–î–æ–±–∞–≤–∏–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã? –ö–ª–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–±–∏—Ä–∞—é—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –∏–ª–∏ —Ä–µ—á—å, '
        '–ø–æ–ª—É—á–∞—é—Ç +5% —Å–∫–∏–¥–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –∏ –≥–æ—Ç–æ–≤—ã–π –∫–æ–º–ø–ª–µ–∫—Ç.'
    )
    keyboard = [
        [InlineKeyboardButton("–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (+2000‚ÇΩ)", callback_data='add_prez')],
        [InlineKeyboardButton("–†–µ—á—å (+1000‚ÇΩ)", callback_data='add_speech')],
        [InlineKeyboardButton("–ë–µ–∑ –¥–æ–ø–æ–≤", callback_data='no_upsell')]
    ]
    if update.message:
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        query = update.callback_query
        await answer_callback_query(query, context)
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return ADD_UPSSELL

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ø—É—Å–ª—É–≥
async def upsell_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    upsells = context.user_data.setdefault('upsells', set())
    added = False
    if data == 'add_prez':
        if 'prez' not in upsells:
            upsells.add('prez')
            added = True
    elif data == 'add_speech':
        if 'speech' not in upsells:
            upsells.add('speech')
            added = True
    elif data == 'no_upsell':
        return await process_order(update, context)
    selected = [UPSELL_LABELS.get(u, u) for u in upsells]
    if added:
        text = '–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–ø—Ü–∏–∏? –ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç +5% —Å–∫–∏–¥–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑.'
    elif upsells:
        text = (
            f"–í—ã —É–∂–µ –≤—ã–±—Ä–∞–ª–∏: {', '.join(selected)}.\n"
            '–°–∫–∏–¥–∫–∞ +5% –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∞ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë?'
        )
    else:
        text = (
            '–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –∏–ª–∏ —Ä–µ—á—å. '
            '–¢–∞–∫ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ +5% —Å–∫–∏–¥–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–∫–∞–∑ –∏ –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –¥–ª—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è.'
        )
    keyboard = [
        [InlineKeyboardButton(f"{'‚úÖ ' if 'prez' in upsells else ''}–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è (+2000‚ÇΩ)", callback_data='add_prez')],
        [InlineKeyboardButton(f"{'‚úÖ ' if 'speech' in upsells else ''}–†–µ—á—å (+1000‚ÇΩ)", callback_data='add_speech')],
        [InlineKeyboardButton("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data='no_upsell')]
    ]
    try:
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    except TelegramError as e:
        if "message is not modified" in str(e).lower():
            pass
    return ADD_UPSSELL

async def process_order(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    type_key = context.user_data.get('current_order_type')
    if not type_key or type_key not in ORDER_TYPES:
        await query.edit_message_text("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∑–∞–∫–∞–∑–∞.")
        return ConversationHandler.END
    topic = context.user_data.get('topic', '–ë–µ–∑ —Ç–µ–º—ã')
    deadline_key = context.user_data.get('deadline_key', DEFAULT_DEADLINE_KEY)
    preset = get_deadline_preset(deadline_key)
    deadline_days = preset['days']
    deadline_label = context.user_data.get('deadline_label', preset['label'])
    requirements = context.user_data.get('requirements', '–ù–µ—Ç')
    contact = context.user_data.get('contact', '')
    contact_link = context.user_data.get('contact_link')
    files = list(context.user_data.get('pending_files', []))
    upsells = list(context.user_data.get('upsells', set()))
    price = calculate_price(type_key, deadline_key)
    extra = sum(UPSELL_PRICES.get(u, 0) for u in upsells)
    price += extra
    order = {
        'type': type_key,
        'topic': topic,
        'deadline_key': deadline_key,
        'deadline_days': deadline_days,
        'deadline_label': deadline_label,
        'requirements': requirements,
        'upsells': upsells,
        'price': price,
        'status': '–Ω–æ–≤—ã–π',
        'contact': contact,
        'contact_link': contact_link,
        'files': files,
    }
    context.user_data.setdefault('cart', []).append(order)
    context.user_data.pop('upsells', None)
    context.user_data.pop('requirements', None)
    context.user_data.pop('deadline_key', None)
    context.user_data.pop('deadline_days', None)
    context.user_data.pop('deadline_label', None)
    context.user_data.pop('topic', None)
    context.user_data.pop('current_order_type', None)
    context.user_data.pop('contact', None)
    context.user_data.pop('contact_link', None)
    context.user_data.pop('pending_files', None)
    return await add_another_order(update, context)

# –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∑–∞–∫–∞–∑
async def add_another_order(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    text = "–î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∑–∞–∫–∞–∑? (–ù–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤ = 10% —Å–∫–∏–¥–∫–∞!)"
    keyboard = [
        [InlineKeyboardButton("–î–∞", callback_data='add_another_yes')],
        [InlineKeyboardButton("–ù–µ—Ç, –æ—Ñ–æ—Ä–º–∏—Ç—å", callback_data='confirm_cart')]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return ADD_ANOTHER_ORDER

async def add_another_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data == 'add_another_yes':
        return await select_order_type(update, context)
    elif data == 'confirm_cart':
        return await confirm_cart(update, context)
    return ADD_ANOTHER_ORDER

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
async def confirm_cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    cart = context.user_data.get('cart', [])
    if not cart:
        await query.edit_message_text("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.")
        return await main_menu(update, context)
    text_lines = ["<b>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å:</b>"]
    total = 0
    for i, order in enumerate(cart, 1):
        order_name = ORDER_TYPES.get(order['type'], {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        contact_display = order.get('contact', '–ù–µ —É–∫–∞–∑–∞–Ω')
        deadline_display = order.get('deadline_label') or f"{order.get('deadline_days', 0)} –¥–Ω–µ–π"
        contact_link = order.get('contact_link')
        if contact_link:
            contact_html = f"<a href=\"{html.escape(contact_link, quote=True)}\">{html.escape(contact_display)}</a>"
        else:
            contact_html = html.escape(contact_display)
        upsell_titles = [UPSELL_LABELS.get(u, u) for u in order.get('upsells', [])]
        if upsell_titles:
            upsell_html = html.escape(', '.join(upsell_titles))
        else:
            upsell_html = '–Ω–µ—Ç'
        text_lines.extend([
            f"{i}. <b>{html.escape(order_name)}</b> ‚Äî {html.escape(order.get('topic', '–ë–µ–∑ —Ç–µ–º—ã'))} ‚Äî {order['price']} ‚ÇΩ",
            f"‚Ä¢ –°—Ä–æ–∫: {html.escape(deadline_display)}",
            f"‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç: {contact_html}",
            f"‚Ä¢ –î–æ–ø—ã: {upsell_html}",
        ])
        if order.get('files'):
            text_lines.append(f"‚Ä¢ –§–∞–π–ª—ã: {len(order['files'])} —à—Ç.")
        total += order['price']
    if len(cart) > 1:
        discount = round_price(total * 0.1)
        total -= discount
        text_lines.append(f"–°–∫–∏–¥–∫–∞ –∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–∫–∞–∑–æ–≤: -{discount} ‚ÇΩ")
    text_lines.append(f"<b>–ò—Ç–æ–≥–æ: {total} ‚ÇΩ</b> ‚Äî —Å—É–º–º–∞ —Å —É—á—ë—Ç–æ–º –¥–æ–ø–æ–≤ –∏ —Å–∫–∏–¥–æ–∫.")
    text_lines.append(
        '–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è '
        '–∏ –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã.'
    )
    text_lines.append("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ?")
    text = "\n".join(text_lines)
    keyboard = [
        [InlineKeyboardButton("–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data='place_order')],
        [InlineKeyboardButton("–û—Ç–º–µ–Ω–∏—Ç—å", callback_data='cancel_cart')]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML, disable_web_page_preview=True)
    return CONFIRM_CART

async def confirm_cart_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data == 'place_order':
        user_id = str(update.effective_user.id)
        user_orders = ORDERS.setdefault(user_id, [])
        existing_ids = [order.get('order_id', 0) for order in user_orders]
        order_id = max(existing_ids, default=0) + 1
        for order in context.user_data['cart']:
            order['order_id'] = order_id
            user_orders.append(order)
            order_id += 1
        save_json(ORDERS_FILE, ORDERS)
        text = (
            "‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.\n"
            "[–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä](https://t.me/Thisissaymoon) —É–∂–µ –ø–æ–ª—É—á–∏–ª –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏ —Ñ–∞–π–ª—ã."
        )
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN)
        if ADMIN_CHAT_ID:
            await notify_admin_about_order(update, context, context.user_data['cart'])
        context.user_data.pop('cart', None)
        return await main_menu(
            update,
            context,
            "–°–ø–∞—Å–∏–±–æ! –•–æ—Ç–∏—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å –µ—â—ë? –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –Ω–∞ —Å–≤—è–∑–∏ ‚Äî [–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä](https://t.me/Thisissaymoon).",
        )
    elif data == 'cancel_cart':
        context.user_data.pop('cart', None)
        return await main_menu(update, context, "–ö–æ—Ä–∑–∏–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –µ—â–µ?")
    return CONFIRM_CART

async def notify_admin_about_order(update: Update, context: ContextTypes.DEFAULT_TYPE, orders):
    if not ADMIN_CHAT_ID:
        return
    user = update.effective_user
    user_id = str(user.id)
    user_link = get_user_link(user)
    user_name = html.escape(user.full_name or user.first_name or str(user.id))
    header = f"üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –æ—Ç <a href=\"{html.escape(user_link, quote=True)}\">{user_name}</a> (ID: {user_id})"
    blocks = []
    for order in orders:
        order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        contact_display = order.get('contact', '–ù–µ —É–∫–∞–∑–∞–Ω')
        contact_link = order.get('contact_link')
        if contact_link:
            contact_html = f"<a href=\"{html.escape(contact_link, quote=True)}\">{html.escape(contact_display)}</a>"
        else:
            contact_html = html.escape(contact_display)
        upsell_titles = [UPSELL_LABELS.get(u, u) for u in order.get('upsells', [])]
        upsell_text = ', '.join(upsell_titles) if upsell_titles else '–Ω–µ—Ç'
        deadline_display = order.get('deadline_label') or f"{order.get('deadline_days', 0)} –¥–Ω–µ–π"
        block = (
            f"#{order.get('order_id', 'N/A')} ‚Äî {html.escape(order_name)}\n"
            f"–¢–µ–º–∞: {html.escape(order.get('topic', '–ë–µ–∑ —Ç–µ–º—ã'))}\n"
            f"–°—Ä–æ–∫: {html.escape(deadline_display)}\n"
            f"–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞: {contact_html}\n"
            f"–î–æ–ø—ã: {html.escape(upsell_text)}\n"
            f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {html.escape(order.get('requirements', '–ù–µ—Ç'))}\n"
            f"–°—É–º–º–∞: {order.get('price', 0)} ‚ÇΩ"
        )
        if order.get('files'):
            block += f"\n–§–∞–π–ª—ã: {len(order['files'])} —à—Ç."
        blocks.append(block)
    message = header + "\n\n" + "\n\n".join(blocks)
    await context.bot.send_message(ADMIN_CHAT_ID, message, parse_mode=ParseMode.HTML)
    for order in orders:
        order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        caption_base = f"–§–∞–π–ª—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ #{order.get('order_id', 'N/A')} ‚Äî {order_name}"
        for file_info in order.get('files', []):
            file_type = file_info.get('type')
            file_id = file_info.get('file_id')
            if not file_id:
                continue
            if file_type == 'document':
                caption = caption_base
                if file_info.get('file_name'):
                    caption += f"\n{file_info['file_name']}"
                await context.bot.send_document(ADMIN_CHAT_ID, file_id, caption=caption)
            elif file_type == 'photo':
                await context.bot.send_photo(ADMIN_CHAT_ID, file_id, caption=caption_base)
            elif file_type == 'audio':
                caption = caption_base
                if file_info.get('file_name'):
                    caption += f"\n{file_info['file_name']}"
                await context.bot.send_audio(ADMIN_CHAT_ID, file_id, caption=caption)
            elif file_type == 'voice':
                await context.bot.send_voice(ADMIN_CHAT_ID, file_id, caption=caption_base)
            elif file_type == 'video':
                caption = caption_base
                if file_info.get('file_name'):
                    caption += f"\n{file_info['file_name']}"
                await context.bot.send_video(ADMIN_CHAT_ID, file_id, caption=caption)
            elif file_type == 'video_note':
                await context.bot.send_video_note(ADMIN_CHAT_ID, file_id)
                await context.bot.send_message(ADMIN_CHAT_ID, caption_base)
            elif file_type == 'animation':
                caption = caption_base
                if file_info.get('file_name'):
                    caption += f"\n{file_info['file_name']}"
                await context.bot.send_animation(ADMIN_CHAT_ID, file_id, caption=caption)
            elif file_type == 'sticker':
                await context.bot.send_sticker(ADMIN_CHAT_ID, file_id)
                await context.bot.send_message(ADMIN_CHAT_ID, caption_base)


async def notify_admin_order_event(context: ContextTypes.DEFAULT_TYPE, user, order: dict, action: str, extra_note: Optional[str] = None):
    if not ADMIN_CHAT_ID:
        return
    user_link = get_user_link(user)
    user_name = html.escape(user.full_name or user.first_name or str(user.id))
    order_id = html.escape(str(order.get('order_id', 'N/A')))
    order_name = html.escape(ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø'))
    status_html = html.escape(build_order_status(order))
    deadline_display = order.get('deadline_label') or f"{order.get('deadline_days', '‚Äî')} –¥–Ω–µ–π"
    contact_display = order.get('contact', '–ù–µ —É–∫–∞–∑–∞–Ω')
    contact_link = order.get('contact_link')
    if contact_link:
        contact_html = f"<a href=\"{html.escape(contact_link, quote=True)}\">{html.escape(contact_display)}</a>"
    else:
        contact_html = html.escape(contact_display)
    lines = [
        f"‚ÑπÔ∏è –ö–ª–∏–µ–Ω—Ç <a href=\"{html.escape(user_link, quote=True)}\">{user_name}</a> {html.escape(action)} –∑–∞–∫–∞–∑ #{order_id} ‚Äî {order_name}.",
        f"–°—Ç–∞—Ç—É—Å: {status_html}.",
        f"–°—Ä–æ–∫: {html.escape(deadline_display)}",
        f"–ö–æ–Ω—Ç–∞–∫—Ç –∫–ª–∏–µ–Ω—Ç–∞: {contact_html}",
    ]
    if extra_note:
        lines.append(html.escape(extra_note))
    await context.bot.send_message(ADMIN_CHAT_ID, "\n".join(lines), parse_mode=ParseMode.HTML, disable_web_page_preview=True)


# –ü–æ–∫–∞–∑ –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–∞
async def show_price_list(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('price_detail_'):
        key = data[13:]
        val = ORDER_TYPES.get(key, {})
        if not val:
            await query.edit_message_text("–û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø.")
            return SHOW_PRICE_LIST
        prices = PRICES.get(key, {})
        min_price = prices.get('min') or prices.get('base')
        rush_price = calculate_price(key, '24h') if prices else None
        text_lines = [
            f"{val.get('icon', '')} *{val.get('name', '')}*",
            "",
            val.get('description', ''),
            val.get('details', ''),
            f"–ü—Ä–∏–º–µ—Ä—ã: {', '.join(val.get('examples', []))}",
        ]
        if min_price:
            text_lines.append(f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: {min_price} ‚ÇΩ")
        if rush_price and rush_price != min_price:
            text_lines.append(f"–°—Ä–æ—á–Ω—ã–π –∑–∞–∫–∞–∑ (24 —á–∞—Å–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ): {rush_price} ‚ÇΩ")
        text_lines.append("\n–ó–∞–∫–∞–∂–∏—Ç–µ —Å–æ —Å–∫–∏–¥–∫–æ–π!")
        text = "\n".join(filter(None, text_lines))
        keyboard = [
            [InlineKeyboardButton("–†–∞—Å—Å—á–∏—Ç–∞—Ç—å", callback_data='price_calculator')],
            [InlineKeyboardButton("–ó–∞–∫–∞–∑–∞—Ç—å", callback_data=f'type_{key}')],
            [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='price_list')]
        ]
        await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN, reply_markup=InlineKeyboardMarkup(keyboard))
        return SHOW_PRICE_LIST
    elif data.startswith('type_'):
        return await view_order_details(update, context)
    elif data == 'price_calculator':
        return await price_calculator(update, context)
    elif data == 'back_to_main':
        return await main_menu(update, context)
    user = update.effective_user
    log_user_action(user.id, user.username, "–ü—Ä–∞–π—Å-–ª–∏—Å—Ç")
    text = "üí≤ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç (10% —Å–∫–∏–¥–∫–∞ —Å–µ–≥–æ–¥–Ω—è! üî•):\n\n"
    for key, val in ORDER_TYPES.items():
        prices = PRICES.get(key, {})
        min_price = prices.get('min') or prices.get('base', 0)
        text += f"{val['icon']} *{val['name']}* ‚Äî –æ—Ç {min_price} ‚ÇΩ\n"
    keyboard = [[InlineKeyboardButton(f"–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ {val['name']}", callback_data=f'price_detail_{key}')] for key, val in ORDER_TYPES.items()]
    keyboard.append([InlineKeyboardButton("üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É", callback_data='price_calculator')])
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')])
    await query.edit_message_text(text, parse_mode=ParseMode.MARKDOWN, reply_markup=InlineKeyboardMarkup(keyboard))
    return SHOW_PRICE_LIST

# –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü–µ–Ω
async def price_calculator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('type_'):
        return await view_order_details(update, context)
    if data.startswith('calc_type_'):
        key = data[10:]
        context.user_data['calc_type'] = key
        descriptions = [
            f"–¢–∏–ø: {ORDER_TYPES.get(key, {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}",
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ ‚Äî —Å–ø–æ–∫–æ–π–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–∞—é—Ç –±–æ–Ω—É—Å—ã:",
            "",
        ]
        for preset in DEADLINE_PRESETS:
            descriptions.append(f"{preset['label']} ‚Äî {preset['badge']}")
        reply_markup = build_deadline_keyboard('calc_dead_', include_back=True, back_callback='price_calculator')
        await query.edit_message_text("\n".join(descriptions), reply_markup=reply_markup)
        return SELECT_CALC_DEADLINE
    elif data == 'back_to_main':
        return await main_menu(update, context)
    user = update.effective_user
    log_user_action(user.id, user.username, "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")
    text = "üßÆ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø:"
    keyboard = [[InlineKeyboardButton(f"{v['icon']} {v['name']}", callback_data=f'calc_type_{k}')] for k, v in ORDER_TYPES.items()]
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return PRICE_CALCULATOR

async def calc_select_deadline(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('calc_dead_'):
        key = data[10:]
        preset = get_deadline_preset(key)
        context.user_data['calc_deadline_key'] = key
        text = f"–°—Ä–æ–∫: {preset['label']}\n{preset['badge']}\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:"
        calc_type = context.user_data.get('calc_type')
        back_target = f'calc_type_{calc_type}' if calc_type else 'price_calculator'
        keyboard = [
            [InlineKeyboardButton("–ü—Ä–æ—Å—Ç–∞—è (–±–∞–∑–æ–≤–∞—è)", callback_data='calc_comp_1.0')],
            [InlineKeyboardButton("–°—Ä–µ–¥–Ω—è—è (+10%)", callback_data='calc_comp_1.1'), InlineKeyboardButton("–°–ª–æ–∂–Ω–∞—è (+30%)", callback_data='calc_comp_1.3')],
            [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data=back_target)]
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
        return SELECT_CALC_COMPLEXITY
    return SELECT_CALC_DEADLINE

async def calc_select_complexity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('calc_comp_'):
        comp_key = data[10:]
        comp = float(comp_key)
        key = context.user_data.get('calc_type')
        if not key:
            return await price_calculator(update, context)
        deadline_key = context.user_data.get('calc_deadline_key', DEFAULT_DEADLINE_KEY)
        preset = get_deadline_preset(deadline_key)
        price = calculate_price(key, deadline_key, comp)
        name = ORDER_TYPES.get(key, {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        complexity_labels = {
            '1.0': '–ü—Ä–æ—Å—Ç–∞—è (–±–∞–∑–æ–≤–∞—è)',
            '1.1': '–°—Ä–µ–¥–Ω—è—è (+10%)',
            '1.3': '–°–ª–æ–∂–Ω–∞—è (+30%)',
        }
        complexity_text = complexity_labels.get(comp_key, f"{int((comp - 1) * 100)}%")
        text = (
            f"–†–∞—Å—á–µ—Ç: {name}\n"
            f"–°—Ä–æ–∫: {preset['label']}\n"
            f"–°–ª–æ–∂–Ω–æ—Å—Ç—å: {complexity_text}\n"
            f"–¶–µ–Ω–∞: {price} ‚ÇΩ (–°–∫–∏–¥–∫–∞ —Å–µ–≥–æ–¥–Ω—è!)\n\n–ó–∞–∫–∞–∑–∞—Ç—å?"
        )
        keyboard = [
            [InlineKeyboardButton("üìù –ó–∞–∫–∞–∑–∞—Ç—å", callback_data=f'type_{key}')],
            [InlineKeyboardButton("–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å", callback_data='price_calculator'), InlineKeyboardButton("–ú–µ–Ω—é", callback_data='back_to_main')]
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
        return PRICE_CALCULATOR
    return SELECT_CALC_COMPLEXITY

# –ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è
async def show_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data if query else None
    if query:
        await answer_callback_query(query, context)
    user = update.effective_user
    if data in (None, 'profile', 'profile_main', 'profile_home'):
        if data == 'profile':
            log_user_action(user.id, user.username, "–ü—Ä–æ—Ñ–∏–ª—å")
        return await render_profile_main(update, context)
    if data == 'profile_back' or data == 'back_to_main':
        return await main_menu(update, context)
    if data == 'profile_orders':
        return await profile_show_orders(update, context)
    if data and data.startswith('profile_order_pause_'):
        order_id = data.rsplit('_', 1)[-1]
        return await profile_toggle_order_pause(update, context, order_id)
    if data and data.startswith('profile_order_delete_'):
        order_id = data.rsplit('_', 1)[-1]
        return await profile_delete_order(update, context, order_id)
    if data and data.startswith('profile_order_remind_'):
        order_id = data.rsplit('_', 1)[-1]
        return await profile_remind_order(update, context, order_id)
    if data and data.startswith('profile_order_'):
        order_id = data.rsplit('_', 1)[-1]
        return await profile_show_order_detail(update, context, order_id)
    if data == 'profile_feedbacks':
        return await profile_show_feedbacks(update, context)
    if data == 'profile_feedback_add':
        return await profile_prompt_feedback(update, context)
    if data and data.startswith('profile_feedback_delete_'):
        index_key = data.rsplit('_', 1)[-1]
        return await profile_delete_feedback(update, context, index_key)
    if data == 'profile_referrals':
        return await profile_show_referrals(update, context)
    if data == 'profile_bonuses':
        return await profile_show_bonuses(update, context)
    return await render_profile_main(update, context)

# –ü–æ–∫–∞–∑ –∑–∞–∫–∞–∑–æ–≤


async def render_profile_main(update: Update, context: ContextTypes.DEFAULT_TYPE, notice: Optional[str] = None):
    user = update.effective_user
    user_id = str(user.id)
    orders = ORDERS.get(user_id, [])
    feedbacks = get_feedback_entries(user_id)
    referrals = REFERALS.get(user_id, [])
    credited, redeemed, balance, _ = get_bonus_summary(user_id)
    ref_link = context.user_data.get('ref_link')
    if not ref_link:
        bot_username = (await context.bot.get_me()).username
        ref_link = f"https://t.me/{bot_username}?start={user_id}"
        context.user_data['ref_link'] = ref_link
    lines = [f"üë§ <b>{html.escape(user.full_name or user.first_name or '–ü—Ä–æ—Ñ–∏–ª—å')}</b>"]
    if notice:
        lines.append(f"<i>{html.escape(notice)}</i>")
    lines.extend([
        f"\nüì¶ –ó–∞–∫–∞–∑—ã: {len(orders)}",
        f"‚≠ê –û—Ç–∑—ã–≤—ã: {len(feedbacks)}",
        f"üë• –†–µ—Ñ–µ—Ä–∞–ª—ã: {len(referrals)}",
        f"üéÅ –ë–æ–Ω—É—Å—ã: {balance} ‚ÇΩ (–Ω–∞—á–∏—Å–ª–µ–Ω–æ {credited} ‚ÇΩ / —Å–ø–∏—Å–∞–Ω–æ {redeemed} ‚ÇΩ)",
        "",
        "–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∫–æ–ø–∏—Ç–µ –±–æ–Ω—É—Å—ã –∑–∞ –∏—Ö –∑–∞–∫–∞–∑—ã!",
        f"–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: <a href=\"{html.escape(ref_link, quote=True)}\">{html.escape(ref_link)}</a>",
    ])
    keyboard = [
        [InlineKeyboardButton("üì¶ –ú–æ–∏ –∑–∞–∫–∞–∑—ã", callback_data='profile_orders')],
        [InlineKeyboardButton("‚≠ê –û—Ç–∑—ã–≤—ã", callback_data='profile_feedbacks')],
        [InlineKeyboardButton("üë• –†–µ—Ñ–µ—Ä–∞–ª—ã", callback_data='profile_referrals'), InlineKeyboardButton("üéÅ –ë–æ–Ω—É—Å—ã", callback_data='profile_bonuses')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')],
    ]
    await edit_or_send(update, context, "\n".join(lines), keyboard)
    return PROFILE_MENU


async def profile_show_orders(update: Update, context: ContextTypes.DEFAULT_TYPE, notice: Optional[str] = None):
    user = update.effective_user
    user_id = str(user.id)
    log_user_action(user.id, user.username, "–ü—Ä–æ—Ñ–∏–ª—å: —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤")
    orders = sorted(ORDERS.get(user_id, []), key=lambda o: o.get('order_id', 0))
    lines = ["üì¶ <b>–í–∞—à–∏ –∑–∞–∫–∞–∑—ã</b>"]
    if notice:
        lines.append(f"<i>{html.escape(notice)}</i>")
    if not orders:
        lines.append("–ü–æ–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç. –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ —á–µ—Ä–µ–∑ —Ä–∞–∑–¥–µ–ª ¬´–°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑¬ª.")
    else:
        for order in orders:
            order_id = order.get('order_id', '‚Äî')
            order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø')
            status = build_order_status(order)
            lines.append(
                f"‚Ä¢ #{html.escape(str(order_id))} ‚Äî {html.escape(order_name)} ({html.escape(status)})"
            )
    keyboard = []
    for order in orders:
        order_id = order.get('order_id')
        if order_id is None:
            continue
        order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ó–∞–∫–∞–∑')
        prefix = '‚è∏ ' if is_order_paused(order) else ''
        label = f"{prefix}#{order_id} ¬∑ {truncate_for_button(order_name)}"
        keyboard.append([InlineKeyboardButton(label, callback_data=f'profile_order_{order_id}')])
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile')])
    await edit_or_send(update, context, "\n".join(lines), keyboard)
    return PROFILE_ORDERS


async def profile_show_order_detail(update: Update, context: ContextTypes.DEFAULT_TYPE, order_id: str, notice: Optional[str] = None):
    user = update.effective_user
    order, _ = find_user_order(user.id, order_id)
    if not order:
        return await profile_show_orders(update, context, notice="–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ —É–¥–∞–ª—ë–Ω.")
    log_user_action(user.id, user.username, f"–ü—Ä–æ—Ñ–∏–ª—å: –∑–∞–∫–∞–∑ #{order_id}")
    order_number = html.escape(str(order.get('order_id', order_id)))
    header = f"üì¶ <b>–ó–∞–∫–∞–∑ #{order_number}</b>"
    details = build_order_detail_text(order)
    parts = [header]
    if notice:
        parts.append(f"<i>{html.escape(notice)}</i>")
    parts.append(details)
    pause_label = "‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å" if is_order_paused(order) else "‚è∏ –ü–∞—É–∑–∞"
    keyboard = [
        [InlineKeyboardButton(pause_label, callback_data=f'profile_order_pause_{order_id}')],
        [InlineKeyboardButton("üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É", callback_data=f'profile_order_remind_{order_id}')],
        [InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑", callback_data=f'profile_order_delete_{order_id}')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ö –∑–∞–∫–∞–∑–∞–º", callback_data='profile_orders')],
        [InlineKeyboardButton("üè† –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
    ]
    await edit_or_send(update, context, "\n\n".join(parts), keyboard)
    return PROFILE_ORDER_DETAIL


async def profile_toggle_order_pause(update: Update, context: ContextTypes.DEFAULT_TYPE, order_id: str):
    user = update.effective_user
    order, _ = find_user_order(user.id, order_id)
    if not order:
        return await profile_show_orders(update, context, notice="–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    if is_order_paused(order):
        previous = order.get('status_before_pause', '–≤ —Ä–∞–±–æ—Ç–µ')
        order['status'] = previous
        order['client_paused'] = False
        order.pop('status_before_pause', None)
        notice = "–ó–∞–∫–∞–∑ –≤–æ–∑–æ–±–Ω–æ–≤–ª—ë–Ω. –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
        action = "–≤–æ–∑–æ–±–Ω–æ–≤–∏–ª"
    else:
        order['status_before_pause'] = order.get('status', '–Ω–æ–≤—ã–π')
        order['status'] = '–Ω–∞ –ø–∞—É–∑–µ (–∫–ª–∏–µ–Ω—Ç)'
        order['client_paused'] = True
        notice = "–ó–∞–∫–∞–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø–∞—É–∑—É. –ú—ã –ø–æ–¥–æ–∂–¥—ë–º –≤–∞—à–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞."
        action = "–ø–æ—Å—Ç–∞–≤–∏–ª –Ω–∞ –ø–∞—É–∑—É"
    save_json(ORDERS_FILE, ORDERS)
    log_user_action(user.id, user.username, f"–ü—Ä–æ—Ñ–∏–ª—å: {action} –∑–∞–∫–∞–∑ #{order_id}")
    if ADMIN_CHAT_ID:
        await notify_admin_order_event(context, user, order, action)
    return await profile_show_order_detail(update, context, order_id, notice=notice)


async def profile_delete_order(update: Update, context: ContextTypes.DEFAULT_TYPE, order_id: str):
    user = update.effective_user
    order, user_orders = find_user_order(user.id, order_id)
    if not order:
        return await profile_show_orders(update, context, notice="–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    user_orders[:] = [o for o in user_orders if str(o.get('order_id')) != str(order_id)]
    if not user_orders:
        ORDERS.pop(str(user.id), None)
    save_json(ORDERS_FILE, ORDERS)
    log_user_action(user.id, user.username, f"–ü—Ä–æ—Ñ–∏–ª—å: —É–¥–∞–ª–∏–ª –∑–∞–∫–∞–∑ #{order_id}")
    if ADMIN_CHAT_ID:
        await notify_admin_order_event(context, user, order, '—É–¥–∞–ª–∏–ª', extra_note='–ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –æ—Ç–º–µ–Ω—É –∑–∞–∫–∞–∑–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª—å.')
    return await profile_show_orders(update, context, notice='–ó–∞–∫–∞–∑ —É–¥–∞–ª—ë–Ω. –ï—Å–ª–∏ –ø–ª–∞–Ω—ã –∏–∑–º–µ–Ω—è—Ç—Å—è ‚Äî —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑.')


async def profile_remind_order(update: Update, context: ContextTypes.DEFAULT_TYPE, order_id: str):
    user = update.effective_user
    order, _ = find_user_order(user.id, order_id)
    if not order:
        return await profile_show_orders(update, context, notice="–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    log_user_action(user.id, user.username, f"–ü—Ä–æ—Ñ–∏–ª—å: –Ω–∞–ø–æ–º–Ω–∏–ª –æ –∑–∞–∫–∞–∑–µ #{order_id}")
    if ADMIN_CHAT_ID:
        deadline = order.get('deadline_label') or f"{order.get('deadline_days', '‚Äî')} –¥–Ω–µ–π"
        extra = f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞. –°—Ä–æ–∫: {deadline}."
        await notify_admin_order_event(context, user, order, '–Ω–∞–ø–æ–º–Ω–∏–ª –æ', extra_note=extra)
    notice = "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É. –ú—ã —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ–º—Å—è!"
    return await profile_show_order_detail(update, context, order_id, notice=notice)


async def profile_show_feedbacks(update: Update, context: ContextTypes.DEFAULT_TYPE, notice: Optional[str] = None):
    user = update.effective_user
    entries = get_feedback_entries(user.id)
    log_user_action(user.id, user.username, "–ü—Ä–æ—Ñ–∏–ª—å: –æ—Ç–∑—ã–≤—ã")
    lines = ["‚≠ê <b>–í–∞—à–∏ –æ—Ç–∑—ã–≤—ã</b>"]
    if notice:
        lines.append(f"<i>{html.escape(notice)}</i>")
    if not entries:
        lines.append("–í—ã –µ—â—ë –Ω–µ –æ—Å—Ç–∞–≤–ª—è–ª–∏ –æ—Ç–∑—ã–≤. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ–º –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å—ã!")
    else:
        for idx, entry in enumerate(entries, 1):
            text = html.escape(entry.get('text', '')) or '‚Äî'
            created = entry.get('created_at')
            if created:
                lines.append(f"{idx}. {text}\n<small>{html.escape(str(created))}</small>")
            else:
                lines.append(f"{idx}. {text}")
    keyboard = [[InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤", callback_data='profile_feedback_add')]]
    if entries:
        row = []
        for idx in range(len(entries)):
            row.append(InlineKeyboardButton(f"üóë ‚Ññ{idx + 1}", callback_data=f'profile_feedback_delete_{idx}'))
            if len(row) == 3:
                keyboard.append(row)
                row = []
        if row:
            keyboard.append(row)
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile')])
    await edit_or_send(update, context, "\n".join(lines), keyboard)
    return PROFILE_FEEDBACKS


async def profile_prompt_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "‚≠ê <b>–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤</b>\n\n"
        f"–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, —á—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å –∏–ª–∏ —á—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å. –ó–∞ –æ—Ç–∑—ã–≤ –Ω–∞—á–∏—Å–ª–∏–º {FEEDBACK_BONUS_AMOUNT} ‚ÇΩ –Ω–∞ –±–æ–Ω—É—Å–Ω—ã–π —Å—á—ë—Ç.\n\n"
        "–ß—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ ¬´‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å¬ª –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel."
    )
    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile_feedbacks')]]
    await edit_or_send(update, context, text, keyboard)
    return PROFILE_FEEDBACK_INPUT


async def input_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    text = (update.message.text or '').strip()
    if not text:
        await update.message.reply_text("–û—Ç–∑—ã–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /cancel.")
        return PROFILE_FEEDBACK_INPUT
    if text.lower() in {'/cancel', '–æ—Ç–º–µ–Ω–∞'}:
        await update.message.reply_text("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return await profile_show_feedbacks(update, context, notice='–û—Ç–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞.')
    entries = get_feedback_entries(user_id)
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    entries.append({'text': text, 'created_at': timestamp})
    save_feedback_entries(user_id, entries)
    add_bonus_operation(user_id, FEEDBACK_BONUS_AMOUNT, 'credit', '–û—Ç–∑—ã–≤ –∫–ª–∏–µ–Ω—Ç–∞')
    await update.message.reply_text(f"–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤! –ù–∞ –±–æ–Ω—É—Å–Ω—ã–π —Å—á—ë—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–æ {FEEDBACK_BONUS_AMOUNT} ‚ÇΩ.")
    if ADMIN_CHAT_ID:
        user_link = get_user_link(user)
        admin_text = (
            f"‚≠ê –ù–æ–≤—ã–π –æ—Ç–∑—ã–≤ –æ—Ç <a href=\"{html.escape(user_link, quote=True)}\">{html.escape(user.full_name or user.first_name or user_id)}</a>\n"
            f"–¢–µ–∫—Å—Ç: {html.escape(text)}"
        )
        await context.bot.send_message(ADMIN_CHAT_ID, admin_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)
    return await profile_show_feedbacks(update, context, notice='–û—Ç–∑—ã–≤ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –∏ –ø–µ—Ä–µ–¥–∞–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É.')


async def profile_delete_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE, index_key: str):
    user = update.effective_user
    user_id = str(user.id)
    entries = get_feedback_entries(user_id)
    try:
        idx = int(index_key)
    except (TypeError, ValueError):
        return await profile_show_feedbacks(update, context, notice='–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ—Ç–∑—ã–≤.')
    if idx < 0 or idx >= len(entries):
        return await profile_show_feedbacks(update, context, notice='–û—Ç–∑—ã–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω.')
    removed = entries.pop(idx)
    save_feedback_entries(user_id, entries)
    log_user_action(user.id, user.username, f"–ü—Ä–æ—Ñ–∏–ª—å: —É–¥–∞–ª–∏–ª –æ—Ç–∑—ã–≤ ‚Ññ{idx + 1}")
    if ADMIN_CHAT_ID:
        user_link = get_user_link(user)
        removed_text = removed.get('text', '')
        admin_text = (
            f"üóë –ö–ª–∏–µ–Ω—Ç <a href=\"{html.escape(user_link, quote=True)}\">{html.escape(user.full_name or user.first_name or user_id)}</a> —É–¥–∞–ª–∏–ª –æ—Ç–∑—ã–≤.\n"
            f"–¢–µ–∫—Å—Ç: {html.escape(removed_text)}"
        )
        await context.bot.send_message(ADMIN_CHAT_ID, admin_text, parse_mode=ParseMode.HTML, disable_web_page_preview=True)
    return await profile_show_feedbacks(update, context, notice='–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω.')


async def profile_show_referrals(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    referrals = REFERALS.get(user_id, [])
    log_user_action(user.id, user.username, "–ü—Ä–æ—Ñ–∏–ª—å: —Ä–µ—Ñ–µ—Ä–∞–ª—ã")
    lines = ["üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>"]
    if not referrals:
        lines.append("–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –¥—Ä—É–∑–µ–π. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –±–æ–Ω—É—Å—ã —Å –∏—Ö –∑–∞–∫–∞–∑–æ–≤!")
    else:
        for idx, ref in enumerate(referrals, 1):
            if isinstance(ref, dict):
                name = ref.get('name') or ref.get('username') or ref.get('user_id') or f"–†–µ—Ñ–µ—Ä–∞–ª ‚Ññ{idx}"
                status = ref.get('status')
                bonus = ref.get('bonus')
                parts = [html.escape(str(name))]
                extras = []
                if status:
                    extras.append(str(status))
                if bonus:
                    extras.append(f"–±–æ–Ω—É—Å {bonus} ‚ÇΩ")
                if extras:
                    parts.append(f"({', '.join(html.escape(item) for item in extras)})")
                lines.append(f"{idx}. {' '.join(parts)}")
            else:
                lines.append(f"{idx}. {html.escape(str(ref))}")
    ref_link = context.user_data.get('ref_link')
    if not ref_link:
        bot_username = (await context.bot.get_me()).username
        ref_link = f"https://t.me/{bot_username}?start={user_id}"
        context.user_data['ref_link'] = ref_link
    lines.extend([
        "",
        f"–í–∞—à–∞ —Å—Å—ã–ª–∫–∞: <a href=\"{html.escape(ref_link, quote=True)}\">{html.escape(ref_link)}</a>",
    ])
    keyboard = [
        [InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
    ]
    await edit_or_send(update, context, "\n".join(lines), keyboard)
    return PROFILE_REFERRALS


async def profile_show_bonuses(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = str(user.id)
    credited, redeemed, balance, history = get_bonus_summary(user_id)
    log_user_action(user.id, user.username, "–ü—Ä–æ—Ñ–∏–ª—å: –±–æ–Ω—É—Å—ã")
    lines = [
        "üéÅ <b>–ë–æ–Ω—É—Å–Ω—ã–π —Å—á—ë—Ç</b>",
        f"–ù–∞—á–∏—Å–ª–µ–Ω–æ: {credited} ‚ÇΩ",
        f"–°–ø–∏—Å–∞–Ω–æ: {redeemed} ‚ÇΩ",
        f"–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å: {balance} ‚ÇΩ",
    ]
    if history:
        lines.append("\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:")
        for item in reversed(history[-5:]):
            if isinstance(item, dict):
                amount = item.get('amount', 0)
                op_type = item.get('type')
                sign = '+' if op_type == 'credit' else '-'
                reason = item.get('reason', '')
                timestamp = item.get('timestamp', '')
                line = f"{timestamp} {sign}{amount} ‚ÇΩ ‚Äî {reason}".strip()
                lines.append(html.escape(line))
            else:
                lines.append(html.escape(str(item)))
    else:
        lines.append("\n–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π.")
    lines.append("\n–ë–æ–Ω—É—Å–∞–º–∏ –º–æ–∂–Ω–æ –æ–ø–ª–∞—Ç–∏—Ç—å —á–∞—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞ ‚Äî —É—Ç–æ—á–Ω–∏—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.")
    keyboard = [
        [InlineKeyboardButton("‚¨ÖÔ∏è –ü—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
    ]
    await edit_or_send(update, context, "\n".join(lines), keyboard)
    return PROFILE_BONUSES

# –ü–æ–∫–∞–∑ FAQ
async def show_faq(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data.startswith('faq_'):
        idx = int(data[4:])
        item = FAQ_ITEMS[idx]
        text = f"‚ùì {item['question']}\n\n{item['answer']}"
        keyboard = [[InlineKeyboardButton("–ù–∞–∑–∞–¥ –∫ FAQ", callback_data='faq')],
                    [InlineKeyboardButton("–ú–µ–Ω—é", callback_data='back_to_main')]]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
        return FAQ_DETAILS
    elif data == 'back_to_main':
        return await main_menu(update, context)
    user = update.effective_user
    log_user_action(user.id, user.username, "FAQ")
    text = "‚ùì FAQ: –í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–ø—Ä–æ—Å"
    keyboard = [[InlineKeyboardButton(item['question'], callback_data=f'faq_{i}')] for i, item in enumerate(FAQ_ITEMS)]
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ú–µ–Ω—é", callback_data='back_to_main')])
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return SHOW_FAQ

# –ü–æ–∫–∞–∑ –∞–¥–º–∏–Ω –º–µ–Ω—é
async def show_admin_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìã –ó–∞–∫–∞–∑—ã", callback_data='admin_orders')],
        [InlineKeyboardButton("üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data='admin_users'), InlineKeyboardButton("üìä –õ–æ–≥–∏", callback_data='admin_logs')],
        [InlineKeyboardButton("üí≤ –¶–µ–Ω—ã", callback_data='admin_prices')],
        [InlineKeyboardButton("üì§ –≠–∫—Å–ø–æ—Ä—Ç", callback_data='admin_export')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –í—ã—Ö–æ–¥", callback_data='back_to_main')]
    ]
    text = "üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"
    if update.callback_query:
        query = update.callback_query
        await answer_callback_query(query, context)
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return ADMIN_MENU

def find_order_for_admin(user_id, order_id):
    user_orders = ORDERS.get(user_id, [])
    for order in user_orders:
        if str(order.get('order_id')) == str(order_id):
            return order, user_orders
    return None, user_orders

async def admin_show_orders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    text_lines = ["üìã –ó–∞–∫–∞–∑—ã (–≤—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å):"]
    keyboard = []
    has_orders = False
    user_ids = sorted(
        ORDERS.keys(),
        key=lambda x: int(x) if str(x).lstrip('-').isdigit() else str(x)
    ) if ORDERS else []
    for uid in user_ids:
        for order in sorted(ORDERS.get(uid, []), key=lambda o: o.get('order_id', 0)):
            order_id = order.get('order_id')
            if order_id is None:
                continue
            status = order.get('status', '–Ω–æ–≤—ã–π')
            button_text = f"#{order_id} ¬∑ {uid} ¬∑ {status}"
            keyboard.append([InlineKeyboardButton(button_text, callback_data=f'admin_view_{uid}_{order_id}')])
            has_orders = True
    if not has_orders:
        text_lines.append("–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.")
    keyboard.append([InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_menu')])
    await query.edit_message_text("\n".join(text_lines), reply_markup=InlineKeyboardMarkup(keyboard))
    return ADMIN_MENU

async def admin_view_order(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str, order_id: str):
    query = update.callback_query
    order, _ = find_order_for_admin(user_id, order_id)
    if not order:
        await query.edit_message_text(
            "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_orders')]])
        )
        return ADMIN_MENU
    order_name = ORDER_TYPES.get(order.get('type'), {}).get('name', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    contact_display = order.get('contact', '–ù–µ —É–∫–∞–∑–∞–Ω')
    contact_link = order.get('contact_link')
    if contact_link:
        contact_html = f"<a href=\"{html.escape(contact_link, quote=True)}\">{html.escape(contact_display)}</a>"
    else:
        contact_html = html.escape(contact_display)
    upsell_titles = [UPSELL_LABELS.get(u, u) for u in order.get('upsells', [])]
    upsell_text = ', '.join(upsell_titles) if upsell_titles else '–Ω–µ—Ç'
    files_count = len(order.get('files', [])) if order.get('files') else 0
    user_link = f"tg://user?id={user_id}"
    deadline_display = order.get('deadline_label') or f"{order.get('deadline_days', 0)} –¥–Ω–µ–π"
    text = (
        f"–ó–∞–∫–∞–∑ #{order.get('order_id', 'N/A')} –æ—Ç <a href=\"{user_link}\">{user_id}</a>\n"
        f"–¢–∏–ø: {html.escape(order_name)}\n"
        f"–°—Ç–∞—Ç—É—Å: {html.escape(order.get('status', '–Ω–æ–≤—ã–π'))}\n"
        f"–¢–µ–º–∞: {html.escape(order.get('topic', '–ë–µ–∑ —Ç–µ–º—ã'))}\n"
        f"–°—Ä–æ–∫: {html.escape(deadline_display)}\n"
        f"–ö–æ–Ω—Ç–∞–∫—Ç: {contact_html}\n"
        f"–î–æ–ø—ã: {html.escape(upsell_text)}\n"
        f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {html.escape(order.get('requirements', '–ù–µ—Ç'))}\n"
        f"–°—É–º–º–∞: {order.get('price', 0)} ‚ÇΩ\n"
        f"–§–∞–π–ª—ã: {files_count}"
    )
    keyboard = [
        [InlineKeyboardButton("–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data=f'admin_cancel_{user_id}_{order_id}')],
        [InlineKeyboardButton("–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑", callback_data=f'admin_delete_{user_id}_{order_id}')],
        [InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_orders')]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)
    return ADMIN_MENU

async def admin_cancel_order(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str, order_id: str):
    query = update.callback_query
    order, _ = find_order_for_admin(user_id, order_id)
    if not order:
        await query.edit_message_text(
            "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_orders')]])
        )
        return ADMIN_MENU
    order['status'] = '–æ—Ç–º–µ–Ω–µ–Ω'
    save_json(ORDERS_FILE, ORDERS)
    return await admin_view_order(update, context, user_id, order_id)

async def admin_delete_order(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: str, order_id: str):
    query = update.callback_query
    order, user_orders = find_order_for_admin(user_id, order_id)
    if not order:
        await query.edit_message_text(
            "–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_orders')]])
        )
        return ADMIN_MENU
    user_orders[:] = [ordr for ordr in user_orders if str(ordr.get('order_id')) != str(order_id)]
    if not user_orders:
        ORDERS.pop(user_id, None)
    save_json(ORDERS_FILE, ORDERS)
    return await admin_show_orders(update, context)

# –ê–¥–º–∏–Ω —Å—Ç–∞—Ä—Ç
async def admin_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_CHAT_ID:
        await update.message.reply_text("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!")
        return
    user = update.effective_user
    log_user_action(user.id, user.username, "–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å")
    return await show_admin_menu(update, context)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–¥–º–∏–Ω-–º–µ–Ω—é
async def admin_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await answer_callback_query(query, context)
    data = query.data
    if data == 'admin_menu':
        return await show_admin_menu(update, context)
    if data == 'admin_orders':
        return await admin_show_orders(update, context)
    if data.startswith('admin_view_'):
        _, _, payload = data.partition('admin_view_')
        parts = payload.split('_')
        if len(parts) >= 2:
            user_id, order_id = parts[0], parts[1]
            return await admin_view_order(update, context, user_id, order_id)
    if data.startswith('admin_cancel_'):
        _, _, payload = data.partition('admin_cancel_')
        parts = payload.split('_')
        if len(parts) >= 2:
            user_id, order_id = parts[0], parts[1]
            return await admin_cancel_order(update, context, user_id, order_id)
    if data.startswith('admin_delete_'):
        _, _, payload = data.partition('admin_delete_')
        parts = payload.split('_')
        if len(parts) >= 2:
            user_id, order_id = parts[0], parts[1]
            return await admin_delete_order(update, context, user_id, order_id)
    text = ""
    keyboard = [[InlineKeyboardButton("–ù–∞–∑–∞–¥", callback_data='admin_menu')]]
    if data == 'admin_users':
        text = "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:\n" + "\n".join(f"ID: {uid}" for uid in ORDERS.keys())
    elif data == 'admin_logs':
        text = "üìä –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10):\n"
        for uid, logs in list(USER_LOGS.items())[-10:]:
            if logs:
                text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid}: {logs[-1]['action']}\n"
    elif data == 'admin_prices':
        text = f"–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: {current_pricing_mode}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (hard/light):"
        context.user_data['admin_state'] = 'change_mode'
    elif data == 'admin_export':
        df = pd.DataFrame([{'user_id': uid, **ord} for uid, ords in ORDERS.items() for ord in ords])
        export_file = os.path.join(DATA_DIR, 'orders_export.csv')
        df.to_csv(export_file, index=False)
        await context.bot.send_document(ADMIN_CHAT_ID, open(export_file, 'rb'))
        os.remove(export_file)
        text = "üì§ –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!"
    elif data == 'back_to_main':
        return await main_menu(update, context)
    await query.edit_message_text(text or "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é.", reply_markup=InlineKeyboardMarkup(keyboard))
    return ADMIN_MENU

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞
async def admin_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    state = context.user_data.get('admin_state')
    if state == 'change_mode':
        global current_pricing_mode
        current_pricing_mode = update.message.text.lower()
        await update.message.reply_text("–†–µ–∂–∏–º –∏–∑–º–µ–Ω–µ–Ω!")
        context.user_data.pop('admin_state')
        return await show_admin_menu(update, context)
    return ADMIN_MENU

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    application = ApplicationBuilder().token(TELEGRAM_BOT_TOKEN).build()
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start), CommandHandler('admin', admin_start)],
        states={
            SELECT_MAIN_MENU: [CallbackQueryHandler(main_menu_handler)],
            SELECT_ORDER_TYPE: [CallbackQueryHandler(select_order_type)],
            VIEW_ORDER_DETAILS: [CallbackQueryHandler(view_order_details)],
            INPUT_TOPIC: [MessageHandler(filters.TEXT & ~filters.COMMAND, input_topic)],
            SELECT_DEADLINE: [CallbackQueryHandler(select_deadline)],
            INPUT_REQUIREMENTS: [
                CallbackQueryHandler(requirements_button_handler, pattern='^requirements_(hint|skip)$'),
                MessageHandler(filters.TEXT & ~filters.COMMAND, input_requirements),
                CommandHandler('skip', skip_requirements),
            ],
            INPUT_CONTACT: [MessageHandler(filters.TEXT & ~filters.COMMAND, input_contact)],
            UPLOAD_FILES: [
                CallbackQueryHandler(file_upload_action, pattern='^files_(done|skip)$'),
                MessageHandler(
                    (
                        filters.Document.ALL
                        | filters.PHOTO
                        | filters.AUDIO
                        | filters.VOICE
                        | filters.VIDEO
                        | filters.VIDEO_NOTE
                        | filters.ANIMATION
                        | filters.Sticker.ALL
                    ),
                    handle_file_upload,
                ),
                CommandHandler('skip', skip_file_upload),
                CommandHandler('done', skip_file_upload),
                MessageHandler(filters.TEXT & ~filters.COMMAND, remind_file_upload),
            ],
            ADD_UPSSELL: [CallbackQueryHandler(upsell_handler)],
            ADD_ANOTHER_ORDER: [CallbackQueryHandler(add_another_handler)],
            CONFIRM_CART: [CallbackQueryHandler(confirm_cart_handler)],
            ADMIN_MENU: [CallbackQueryHandler(admin_menu_handler), MessageHandler(filters.TEXT & ~filters.COMMAND, admin_message)],
            PROFILE_MENU: [CallbackQueryHandler(show_profile)],
            PROFILE_ORDERS: [CallbackQueryHandler(show_profile)],
            PROFILE_ORDER_DETAIL: [CallbackQueryHandler(show_profile)],
            PROFILE_FEEDBACKS: [CallbackQueryHandler(show_profile)],
            PROFILE_REFERRALS: [CallbackQueryHandler(show_profile)],
            PROFILE_BONUSES: [CallbackQueryHandler(show_profile)],
            SHOW_PRICE_LIST: [CallbackQueryHandler(show_price_list)],
            PRICE_CALCULATOR: [CallbackQueryHandler(price_calculator)],
            SELECT_CALC_DEADLINE: [CallbackQueryHandler(calc_select_deadline)],
            SELECT_CALC_COMPLEXITY: [CallbackQueryHandler(calc_select_complexity)],
            SHOW_FAQ: [CallbackQueryHandler(show_faq)],
            FAQ_DETAILS: [CallbackQueryHandler(show_faq)],
            PROFILE_FEEDBACK_INPUT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, input_feedback),
                CallbackQueryHandler(show_profile),
            ],
        },
        fallbacks=[CommandHandler('start', start)],
    )
    application.add_handler(conv_handler)
    application.add_error_handler(error_handler)
    application.run_polling(drop_pending_updates=True)

if __name__ == '__main__':
    main()
